<!DOCTYPE html>
<!-- SigmaForm Quiz Frontend - Deployed: 09/24/25:09:20:00 - Updated BFF_BASE_URL for new Vercel deployment -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 6 Math Quiz</title>

    <!-- Content Security Policy optimized for Google Identity Services -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://*.google.com https://*.gstatic.com https://*.googleapis.com; connect-src 'self' https://*.google.com https://*.googleapis.com https://script.google.com https://script.googleusercontent.com https://*.vercel.app; img-src 'self' https: data:; style-src 'self' 'unsafe-inline' https://*.google.com; frame-src https://*.google.com https://*.googleapis.com https://content-sheets.googleapis.com https://content.googleapis.com;">
    
    <!-- Google Identity Services - with error handling -->
    <script src="https://accounts.google.com/gsi/client" async defer onerror="handleGISLoadError()"></script>
    <!-- Google APIs for Sheets access -->
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .quiz-container {
            background: white;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 600px;
            width: 90%;
            position: relative;
            overflow: hidden;
        }

        .quiz-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f, #4d96ff, #9c88ff);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5em;
            color: #4a5568;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar {
            background: #e2e8f0;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #ff6b6b, #4d96ff);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }

        .score-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }

        .star-container {
            display: flex;
            gap: 5px;
        }

        .star {
            font-size: 2em;
            transition: all 0.3s ease;
            filter: grayscale(100%);
        }

        .star.earned {
            filter: grayscale(0%);
            transform: scale(1.2);
            animation: sparkle 0.6s ease;
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1.2); }
            50% { transform: scale(1.4) rotate(10deg); }
        }

        .question-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .question-number {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.4em;
            line-height: 1.4;
        }

        .topic-badge {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .answer-section {
            margin: 30px 0;
        }

        .answer-input {
            width: 100%;
            padding: 15px;
            border: 3px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.2em;
            outline: none;
            transition: all 0.3s ease;
        }

        .answer-input:focus {
            border-color: #4d96ff;
            box-shadow: 0 0 0 3px rgba(77, 150, 255, 0.2);
        }

        .multiple-choice {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .choice-button {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .choice-button.selected {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            transform: scale(1.02);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }

        .nav-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.5s ease;
        }

        .feedback.correct {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #2d5016;
        }

        .feedback.incorrect {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #c53030;
        }

        .feedback.pulse {
            animation: feedbackPulse 0.6s ease-in-out;
        }

        @keyframes feedbackPulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            25% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.02);
                opacity: 0.9;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .feedback-popup {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            animation: popupSlideIn 0.4s ease-out;
            max-width: 90%;
            word-wrap: break-word;
        }

        .feedback-popup.correct {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #2d5016;
            border: 3px solid #48bb78;
        }

        .feedback-popup.incorrect {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #c53030;
            border: 3px solid #f56565;
        }

        @keyframes popupSlideIn {
            0% {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
                scale: 0.8;
            }
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
                scale: 1;
            }
        }

        @keyframes slideInRight {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4a5568;
            font-size: 1.2em;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4d96ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .question-counter {
            font-size: 1.1em;
            color: #666;
            font-weight: bold;
        }

        /* New styles for login section */
        .login-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.7); /* Semi-transparent overlay */
            z-index: 1000;
        }

        .login-container {
            background: white;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        .login-title {
            font-size: 2.5em;
            color: #4a5568;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .login-subtitle {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
        }

        .user-info {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }

        .user-info img {
            border: 2px solid #4d96ff;
        }

        .user-info button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-info button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Google OAuth Login Section -->
    <div id="loginSection" class="login-section" style="display: none;">
        <div class="login-container">
            <h1 class="login-title">üßÆ Math Quiz Adventure! üåü</h1>
            <p class="login-subtitle">Sign in with Google to start your math adventure!</p>
            <!-- #claude Security: Configure Google Identity Services with security best practices -->
            <div id="g_id_onload"
                 data-client_id="141726088289-7rvc4j711ac0ospiiuam4bdmuklahsbe.apps.googleusercontent.com"
                 data-context="signin"
                 data-ux_mode="popup"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false"
                 data-cancel_on_tap_outside="false"
                 data-use_fedcm_for_prompt="true"
                 data-one_tap="true"
                 data-prompt_parent_id="loginSection">
            </div>
            <div class="g_id_signin"
                 data-type="standard"
                 data-shape="rectangular"
                 data-theme="outline"
                 data-text="signin_with"
                 data-size="large"
                 data-logo_alignment="left">
            </div>
        </div>
    </div>

    <div class="quiz-container" id="quizContainer" style="display: none;">
        <div class="header">
            <h1 class="title">üßÆ Math Quiz Adventure! üåü</h1>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="score-display">
                <span style="font-size: 1.2em; font-weight: bold; color: #4a5568;">Score:</span>
                <div class="star-container" id="starContainer">
                    <span class="star">‚≠ê</span>
                    <span class="star">‚≠ê</span>
                    <span class="star">‚≠ê</span>
                    <span class="star">‚≠ê</span>
                    <span class="star">‚≠ê</span>
                </div>
                <span id="scoreText" style="font-size: 1.2em; font-weight: bold; color: #4a5568;">0/5</span>
            </div>
        </div>

        <div id="loadingScreen" class="loading">
            <div class="spinner"></div>
            <div>Loading your math adventure...</div>
        </div>

        <div id="quizContent" style="display: none;">
            <div class="question-counter">
                <span id="questionCounter">Question 1 of 5</span>
            </div>

            <!-- Floating feedback popup for better visibility -->
            <div id="feedbackPopup" class="feedback-popup" style="display: none;"></div>

            <div class="question-card">
                <div class="question-number" id="questionNumber">Question 1</div>
                <div class="question-text" id="questionText">Loading question...</div>
                <div class="topic-badge" id="topicBadge">Topic</div>
            </div>

            <div class="answer-section">
                <input type="text" class="answer-input" id="textAnswer" placeholder="Type your answer here..." style="display: none;">
                <div class="multiple-choice" id="multipleChoice" style="display: none;"></div>
            </div>

            <div class="controls">
                <button class="nav-button" id="prevButton" disabled>
                    ‚Üê Previous
                </button>
                <button class="submit-button" id="submitButton">Submit Answer</button>
                <button class="nav-button" id="nextButton" disabled>
                    Next ‚Üí
                </button>
            </div>

            <div id="feedback" class="feedback" style="display: none;"></div>
        </div>
    </div>

    <script>
        class MathQuiz {
            constructor(questions = null) {
                this.questions = questions || [];
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.answers = {};
                this.attempts = {}; // Track attempts per question
                this.selectedChoice = null;
                
                if (questions) {
                    // Questions provided, initialize directly
                    this.initWithQuestions();
                } else {
                    // No questions provided, load from Apps Script
                this.init();
                }
            }

            initWithQuestions() {
                // Questions already loaded, initialize directly
                this.setupEventListeners();
                this.displayQuestion();
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('quizContent').style.display = 'block';
            }

            async init() {
                try {
                    await this.loadQuestions();
                    this.setupEventListeners();
                    this.displayQuestion();
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('quizContent').style.display = 'block';
                } catch (error) {
                    document.getElementById('loadingScreen').innerHTML = `
                        <div style="color: #e53e3e; text-align: center; padding: 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">üìö</div>
                            <h2 style="color: #4a5568; margin-bottom: 15px;">Quiz Loading Issue</h2>
                            <p style="color: #666; margin-bottom: 20px; font-size: 1.1em;">
                                We're having trouble connecting to the quiz database. This usually resolves quickly.
                            </p>
                            <div style="background: #f7fafc; border-radius: 10px; padding: 15px; margin: 20px 0;">
                                <p style="color: #4a5568; font-size: 0.9em; line-height: 1.4;">
                                    <strong>What you can try:</strong><br>
                                    ‚Ä¢ Refresh this page in a few seconds<br>
                                    ‚Ä¢ Check your internet connection<br>
                                    ‚Ä¢ Contact your teacher if the issue persists
                                </p>
                            </div>
                            <button onclick="location.reload()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1.1em; cursor: pointer; margin-top: 15px;">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            }

            async loadQuestions() {
                // ‚úÖ Production Apps Script URL for SigmaForm Quiz
                const APPS_SCRIPT_URL = 'https://github-io-topaz-one.vercel.app/api/questions';
                
                
                console.log('üîÑ STEP 1: Starting to load questions from Google Sheets...');
                console.log('üîó STEP 2: Using Apps Script URL:', APPS_SCRIPT_URL);
                
                // First, let's test if we can reach the URL at all
                console.log('üß™ TESTING: Can we reach the Apps Script URL?');
                try {
                    console.log('üì° STEP 3: Making fetch request...');
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    console.log('üìä STEP 4: Response received');
                    console.log('üìä STEP 4a: Response status:', response.status);
                    console.log('üìä STEP 4b: Response ok:', response.ok);
                    console.log('üìä STEP 4c: Response type:', response.type);
                    console.log('üìä STEP 4d: Response url:', response.url);
                    
                    if (!response.ok) {
                        console.error('‚ùå Response not OK:', response.status, response.statusText);
                        throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                    }
                    
                    console.log('üìù STEP 5: Getting response text...');
                    const csvText = await response.text();
                    console.log('üìù STEP 6: CSV text received, length:', csvText.length);
                    console.log('üìù STEP 6b: First 300 characters:', csvText.substring(0, 300));
                    console.log('üìù STEP 6c: CSV text type:', typeof csvText);
                    
                    if (!csvText || csvText.length === 0) {
                        throw new Error('Empty response from Apps Script - check your script');
                    }
                    
                    console.log('üîç STEP 7: Parsing CSV...');
                    this.questions = this.parseCSV(csvText);
                    console.log('‚úÖ STEP 8: Parsed questions count:', this.questions.length);
                    
                    if (this.questions.length > 0) {
                        console.log('‚úÖ STEP 8b: First question sample:', this.questions[0]);
                    }
                    
                    if (this.questions.length === 0) {
                        throw new Error('No questions found in spreadsheet - check CSV format and parsing');
                    }
                    
                    console.log('üéâ SUCCESS: Questions loaded successfully!');
                    
                } catch (error) {
                    console.error('‚ùå DETAILED ERROR:', error);
                    console.error('‚ùå ERROR name:', error.name);
                    console.error('‚ùå ERROR message:', error.message);
                    
                    // Provide specific troubleshooting based on error type
                    if (error.name === 'TypeError' && error.message.includes('NetworkError')) {
                        console.log('üîß NETWORK ERROR TROUBLESHOOTING:');
                        console.log('1. Check if your Apps Script is deployed as a Web App');
                        console.log('2. Verify "Anyone" access is set in deployment');
                        console.log('3. Try accessing this URL directly in a new browser tab:', APPS_SCRIPT_URL);
                        
                        throw new Error(`Network error accessing Apps Script. Please:
                        1. Verify your Apps Script is deployed as a Web App
                        2. Set access to "Anyone" in the deployment settings
                        3. Test the URL directly: ${APPS_SCRIPT_URL}`);
                    } else {
                        throw error;
                    }
                }
            }

            parseCSV(csvText) {
                console.log('üîç PARSING CSV - Raw text length:', csvText.length);
                
                const lines = csvText.split('\n').filter(line => line.trim());
                console.log('üîç PARSING CSV - Total lines after filtering:', lines.length);
                console.log('üîç PARSING CSV - First few lines:', lines.slice(0, 3));
                
                const questions = [];
                
                // Skip header row (starts at index 1)
                for (let i = 1; i < lines.length; i++) {
                    console.log(`üîç PARSING LINE ${i}:`, lines[i]);
                    
                    try {
                        // Handle CSV parsing with potential commas in quoted fields
                        const columns = this.parseCSVLine(lines[i]);
                        console.log(`üîç PARSED COLUMNS ${i}:`, columns);
                        
                        if (columns.length >= 5) {
                            const question = {
                                number: parseInt(columns[0]) || i,
                                question: columns[1]?.trim() || '',
                                topic: columns[2]?.trim() || '',
                                answerType: columns[3]?.trim() || 'Short Answer',
                                answer: columns[4]?.trim() || ''
                            };
                            
                            console.log(`üìù QUESTION OBJECT ${i}:`, question);
                            
                            // Handle Multiple Choice questions
                            if (question.answerType === 'Multiple Choice') {
                                console.log(`üéØ PROCESSING MULTIPLE CHOICE for question ${i}`);
                                const answerText = question.answer;
                                
                                // Extract choices (look for A), B), C), D) pattern)
                                const choiceMatches = answerText.match(/[A-D]\)[^A-D\[\]]+/g);
                                if (choiceMatches) {
                                    question.choices = choiceMatches.map(choice => choice.trim());
                                    console.log(`üéØ FOUND CHOICES:`, question.choices);
                                }
                                
                                // Extract correct answer (look for [Correct: X] pattern)
                                const correctMatch = answerText.match(/\[Correct:\s*([A-D])\]/i);
                                if (correctMatch) {
                                    question.answer = correctMatch[1].toUpperCase();
                                    console.log(`üéØ CORRECT ANSWER:`, question.answer);
                                } else {
                                    // Default to A if no correct answer specified
                                    question.answer = 'A';
                                    console.log(`‚ö†Ô∏è NO CORRECT ANSWER FOUND, defaulting to A`);
                                }
                            }
                            
                            questions.push(question);
                            console.log(`‚úÖ ADDED QUESTION ${question.number} to array`);
                        } else {
                            console.log(`‚ö†Ô∏è SKIPPING LINE ${i} - insufficient columns (${columns.length})`);
                        }
                    } catch (error) {
                        console.warn(`‚ùå Error parsing line ${i}:`, lines[i], error);
                    }
                }
                
                console.log('‚úÖ FINAL QUESTIONS ARRAY:', questions);
                return questions;
            }

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current); // Don't forget the last column
                return result;
            }

            setupEventListeners() {
                document.getElementById('submitButton').addEventListener('click', () => this.submitAnswer());
                document.getElementById('prevButton').addEventListener('click', () => this.previousQuestion());
                document.getElementById('nextButton').addEventListener('click', () => this.nextQuestion());
                
                document.getElementById('textAnswer').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.submitAnswer();
                });
            }

            displayQuestion() {
                const question = this.questions[this.currentQuestionIndex];
                
                document.getElementById('questionNumber').textContent = `Question ${question.questionNumber || this.currentQuestionIndex + 1}`;
                document.getElementById('questionText').textContent = question.question;
                document.getElementById('topicBadge').textContent = question.topic;
                document.getElementById('questionCounter').textContent = `Question ${this.currentQuestionIndex + 1} of ${this.questions.length}`;
                
                this.updateProgress();
                this.setupAnswerInput(question);
                this.updateNavigationButtons();
                this.hideFeedback();
            }

            setupAnswerInput(question) {
                const textInput = document.getElementById('textAnswer');
                const multipleChoice = document.getElementById('multipleChoice');
                
                if (question.answerType === 'Multiple Choice') {
                    textInput.style.display = 'none';
                    multipleChoice.style.display = 'grid';
                    multipleChoice.innerHTML = '';
                    
                    question.choices.forEach((choice, index) => {
                        const button = document.createElement('button');
                        button.className = 'choice-button';
                        button.textContent = choice;
                        button.addEventListener('click', () => this.selectChoice(index, button));
                        multipleChoice.appendChild(button);
                    });
                } else {
                    textInput.style.display = 'block';
                    multipleChoice.style.display = 'none';
                    textInput.value = this.answers[this.currentQuestionIndex] || '';
                    textInput.focus();
                    this.selectedChoice = null;
                }
            }

            selectChoice(index, button) {
                console.log('üîç selectChoice called with index:', index);
                document.querySelectorAll('.choice-button').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                this.selectedChoice = index;
                console.log('üîç selectedChoice set to:', this.selectedChoice);
            }

            async submitAnswer() {
                const question = this.questions[this.currentQuestionIndex];
                let userAnswer;
                
                if (question.answerType === 'Multiple Choice') {
                    console.log('üîç submitAnswer: selectedChoice is:', this.selectedChoice);
                    if (this.selectedChoice === null) {
                        alert('Please select an answer!');
                        return;
                    }
                    userAnswer = String.fromCharCode(65 + this.selectedChoice); // Convert to A, B, C, D
                } else {
                    userAnswer = document.getElementById('textAnswer').value.trim();
                    if (!userAnswer) {
                        alert('Please enter an answer!');
                        return;
                    }
                }
                
                this.answers[this.currentQuestionIndex] = userAnswer;
                
                // Use BFF to validate answer securely
                const result = await this.checkAnswer(userAnswer, question.questionNumber || this.currentQuestionIndex + 1);

                if (result.correct && !this.isQuestionAnswered(this.currentQuestionIndex)) {
                    this.score += result.points || 1;
                    this.updateStars();
                }
                
                this.showFeedback(result.correct, result.notes || '');
                this.updateNavigationButtons();

                // Update answer in user's spreadsheet
                try {
                    const timestamp = new Date().toISOString();
                    const questionNum = question.questionNumber || this.currentQuestionIndex + 1;

                    // Track attempts for this question
                    this.attempts[this.currentQuestionIndex] = (this.attempts[this.currentQuestionIndex] || 0) + 1;

                    await updateAnswerInSpreadsheet(
                        questionNum,
                        userAnswer,
                        result.correct,
                        this.attempts[this.currentQuestionIndex],
                        timestamp
                    );
                } catch (error) {
                    console.log('‚ö†Ô∏è Spreadsheet update failed, continuing quiz:', error);
                }
            }

            async checkAnswer(userAnswer, questionNumber) {
                try {
                    // Session is handled by HttpOnly cookies automatically
                    const response = await fetch(`${BFF_BASE_URL}/validate`, {
                        method: 'POST',
                        credentials: 'include', // Include HttpOnly cookies
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            questionNumber: questionNumber,
                            userAnswer: userAnswer
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            // Session expired, clear and redirect to login
                            clearSession();
                            showLogin();
                            throw new Error('Session expired. Please sign in again.');
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('‚úÖ Answer validated securely via BFF');
                    return result; // Returns { correct: boolean, points: number, notes: string }
                } catch (error) {
                    console.error('‚ùå Error validating answer:', error);
                    return { correct: false, points: 0, notes: 'Error validating answer' };
                }
            }

            isQuestionAnswered(index) {
                return this.answers.hasOwnProperty(index);
            }

            showFeedback(isCorrect, correctAnswer) {
                // Hide old feedback first
                this.hideFeedback();

                // Show floating popup feedback
                const popup = document.getElementById('feedbackPopup');
                popup.style.display = 'block';

                if (isCorrect) {
                    popup.className = 'feedback-popup correct';
                    popup.innerHTML = 'üéâ Excellent! You got it right! ‚≠ê';
                } else {
                    popup.className = 'feedback-popup incorrect';
                    popup.innerHTML = '‚ùå Not quite right. Try again!';
                }

                // Auto-hide popup after 3 seconds
                setTimeout(() => {
                    this.hideFeedback();
                }, 3000);
            }

            hideFeedback() {
                document.getElementById('feedback').style.display = 'none';
                document.getElementById('feedbackPopup').style.display = 'none';
            }

            updateStars() {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    if (index < this.score) {
                        star.classList.add('earned');
                    }
                });
                
                document.getElementById('scoreText').textContent = `${this.score}/${this.questions.length}`;
            }

            updateProgress() {
                const progress = ((this.currentQuestionIndex + 1) / this.questions.length) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
            }

            updateNavigationButtons() {
                const prevButton = document.getElementById('prevButton');
                const nextButton = document.getElementById('nextButton');
                const submitButton = document.getElementById('submitButton');
                
                prevButton.disabled = this.currentQuestionIndex === 0;
                nextButton.disabled = this.currentQuestionIndex === this.questions.length - 1;
                
                if (this.isQuestionAnswered(this.currentQuestionIndex)) {
                    submitButton.textContent = 'Update Answer';
                    nextButton.disabled = false;
                } else {
                    submitButton.textContent = 'Submit Answer';
                }
            }

            previousQuestion() {
                if (this.currentQuestionIndex > 0) {
                    this.currentQuestionIndex--;
                    this.displayQuestion();
                }
            }

            nextQuestion() {
                if (this.currentQuestionIndex < this.questions.length - 1) {
                    this.currentQuestionIndex++;
                    this.displayQuestion();
                }
            }
        }



        // BFF Configuration
        // ‚úÖ Updated URL for new deployment with correct Google Sheets IDs
        const BFF_BASE_URL = 'https://sigmaformbackend-git-main-sevenphases-projects.vercel.app/api';

        // Google OAuth Configuration for Sheets API access
        const GOOGLE_CLIENT_ID = '141726088289-7rvc4j711ac0ospiiuam4bdmuklahsbe.apps.googleusercontent.com';
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
        const QUESTIONS_SHEET_NAME = 'SigmaForm-Math-Quiz-Questions'; // Base name for user answer sheets

        // Modern Google Identity Services for Sheets API
        let gapiLoaded = false;
        let accessToken = null;

        // Initialize Google APIs with modern GIS
        function initializeGoogleAPIs() {
            return new Promise((resolve, reject) => {
                if (typeof gapi === 'undefined') {
                    console.log('‚è≥ Waiting for Google APIs to load...');
                    setTimeout(() => initializeGoogleAPIs().then(resolve).catch(reject), 100);
                    return;
                }

                gapi.load('client', () => {
                    gapi.client.init({
                        discoveryDocs: [
                            'https://sheets.googleapis.com/$discovery/rest?version=v4',
                            'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
                        ]
                    }).then(() => {
                        console.log('‚úÖ Google Sheets API client initialized');
                        gapiLoaded = true;
                        resolve();
                    }).catch(reject);
                });
            });
        }

        // Request OAuth access token using modern GIS
        function requestSheetsAccess() {
            return new Promise((resolve, reject) => {
                if (typeof google === 'undefined' || !google.accounts) {
                    reject(new Error('Google Identity Services not loaded'));
                    return;
                }

                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: GOOGLE_SCOPES,
                    callback: (response) => {
                        if (response.error) {
                            reject(response);
                            return;
                        }
                        accessToken = response.access_token;
                        gapi.client.setToken({access_token: accessToken});
                        console.log('‚úÖ Sheets access token obtained');
                        resolve(accessToken);
                    }
                });

                tokenClient.requestAccessToken({prompt: 'consent'});
            });
        }

        // Create or open user answer spreadsheet
        async function createOrOpenUserAnswerSheet(userInfo, questionsCount) {
            try {
                if (!gapiLoaded) {
                    await initializeGoogleAPIs();
                }

                // Request Sheets access using modern GIS
                if (!accessToken) {
                    console.log('üîê Requesting Google Sheets access...');
                    await requestSheetsAccess();
                }

                const userName = userInfo.name?.replace(/[^a-zA-Z0-9]/g, '-') || 'User';
                const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                const spreadsheetTitle = `${timestamp}-${QUESTIONS_SHEET_NAME}-Answers-${userName}`;

                console.log(`üîç Looking for existing spreadsheet: ${spreadsheetTitle}`);

                // Search for existing spreadsheet
                const searchResponse = await gapi.client.request({
                    path: 'https://www.googleapis.com/drive/v3/files',
                    params: {
                        q: `name='${spreadsheetTitle}' and mimeType='application/vnd.google-apps.spreadsheet'`,
                        spaces: 'drive'
                    }
                });

                let spreadsheetId;

                if (searchResponse.result.files && searchResponse.result.files.length > 0) {
                    // Spreadsheet exists, use it
                    spreadsheetId = searchResponse.result.files[0].id;
                    console.log('‚úÖ Found existing answer spreadsheet:', spreadsheetId);
                } else {
                    // Create new spreadsheet
                    console.log('üìù Creating new answer spreadsheet...');

                    const createResponse = await gapi.client.request({
                        path: 'https://sheets.googleapis.com/v4/spreadsheets',
                        method: 'POST',
                        body: {
                            properties: {
                                title: spreadsheetTitle
                            },
                            sheets: [{
                                properties: {
                                    title: 'Answers',
                                    gridProperties: {
                                        rowCount: questionsCount + 10,
                                        columnCount: 10
                                    }
                                }
                            }]
                        }
                    });

                    spreadsheetId = createResponse.result.spreadsheetId;

                    // Add headers and question numbers
                    const headers = [['Question Number', 'User Answer', 'Correct', 'Attempt Count', 'Timestamp']];
                    const questionRows = [];

                    for (let i = 1; i <= questionsCount; i++) {
                        questionRows.push([i, '', '', '', '']);
                    }

                    await gapi.client.request({
                        path: `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Answers!A1:E${questionsCount + 1}`,
                        method: 'PUT',
                        params: { valueInputOption: 'RAW' },
                        body: {
                            values: [headers[0], ...questionRows]
                        }
                    });

                    console.log('‚úÖ Created new answer spreadsheet:', spreadsheetId);
                }

                // Store spreadsheet ID for later use
                sessionStorage.setItem('user_answer_sheet_id', spreadsheetId);

                return {
                    spreadsheetId: spreadsheetId,
                    spreadsheetUrl: `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`,
                    title: spreadsheetTitle,
                    isNew: !searchResponse.result.files?.length
                };

            } catch (error) {
                console.error('‚ùå Error creating/opening answer spreadsheet:', error);
                throw error;
            }
        }

        // Update answer in user's spreadsheet
        async function updateAnswerInSpreadsheet(questionNumber, userAnswer, isCorrect, attemptCount, timestamp) {
            try {
                const spreadsheetId = sessionStorage.getItem('user_answer_sheet_id');
                if (!spreadsheetId) {
                    console.log('‚ö†Ô∏è No spreadsheet ID found, skipping update');
                    return;
                }

                if (!accessToken) {
                    console.log('‚ö†Ô∏è No access token, requesting Sheets access...');
                    await requestSheetsAccess();
                }

                // Calculate the row number (question number + 1 to account for header)
                const rowNumber = questionNumber + 1;
                const range = `Answers!B${rowNumber}:E${rowNumber}`;

                // Prepare the update data
                const values = [[
                    userAnswer,                    // Column B: User Answer
                    isCorrect ? 'TRUE' : 'FALSE', // Column C: Correct
                    attemptCount,                  // Column D: Attempt Count
                    timestamp                      // Column E: Timestamp
                ]];

                // Update the spreadsheet
                const updateResponse = await gapi.client.request({
                    path: `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}`,
                    method: 'PUT',
                    params: { valueInputOption: 'RAW' },
                    body: { values: values }
                });

                console.log(`‚úÖ Updated answer for question ${questionNumber} in spreadsheet`);
                return updateResponse;

            } catch (error) {
                console.error('‚ùå Error updating spreadsheet:', error);
                // Don't throw error - quiz should continue even if spreadsheet update fails
                showNotification('‚ö†Ô∏è Could not save to spreadsheet, but quiz continues', 'warning');
            }
        }

        // Show notification to user
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#48bb78' : type === 'warning' ? '#ed8936' : '#4299e1'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 300px;
                font-size: 0.9em;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        // Handle Google Identity Services loading errors
        function handleGISLoadError() {
            console.error('‚ùå Google Identity Services failed to load');
            const loginSection = document.getElementById('loginSection');
            if (loginSection) {
                loginSection.innerHTML = `
                    <div class="login-container">
                        <h2>‚ö†Ô∏è Authentication Service Unavailable</h2>
                        <p>Google Identity Services could not be loaded. This may be due to:</p>
                        <ul style="text-align: left; margin: 20px 0;">
                            <li>Browser blocking third-party scripts</li>
                            <li>Ad blockers or privacy extensions</li>
                            <li>Strict CORS policies</li>
                            <li>Network connectivity issues</li>
                        </ul>
                        <p><strong>Try:</strong></p>
                        <ul style="text-align: left; margin: 20px 0;">
                            <li>Refreshing the page</li>
                            <li>Trying a different browser</li>
                            <li>Disabling browser extensions temporarily</li>
                            <li>Checking your internet connection</li>
                        </ul>
                        <button onclick="location.reload()" style="padding: 10px 20px; font-size: 1em; cursor: pointer;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // Session Management Functions
        async function initializeAuth() {
            console.log('üöÄ Initializing authentication...');
            
            // Test BFF connection first
            testBFFConnection().then(async () => {
                // Check if user has a valid session by trying to load questions
                console.log('üìã Checking for existing HttpOnly session...');
                try {
                    const response = await fetch(`${BFF_BASE_URL}/questions`, {
                        credentials: 'include' // Include HttpOnly cookies
                    });

                    if (response.ok) {
                        console.log('‚úÖ Valid session found, loading quiz...');
                        await showQuiz();
                    } else {
                        console.log('üîê No valid session, showing login');
                        showLogin();
                    }
                } catch (error) {
                    console.log('üîê Session check failed, showing login');
                    showLogin();
                }
            }).catch(error => {
                console.error('‚ùå BFF connection test failed:', error);
                showLogin(); // Still show login even if BFF test fails
            });
        }
        
        async function testBFFConnection() {
            try {
                console.log('üß™ Testing BFF connection...');
                const response = await fetch(BFF_BASE_URL);
                console.log('üì° BFF test response:', response.status, response.statusText);
                
                if (response.status === 404) {
                    console.log('‚úÖ BFF responding (404 expected for no params)');
                    return;
                } else if (response.ok) {
                    console.log('‚úÖ BFF responding normally');
                    return;
                } else {
                    throw new Error(`BFF returned ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå BFF connection failed:', error);
                throw error;
            }
        }
        
        async function validateSession(sessionId) {
            try {
                console.log('üîç Validating session:', sessionId);
                const url = `${BFF_BASE_URL}?path=questions&session=${sessionId}`;
                console.log('üì° Fetching:', url);
                
                const response = await fetch(url);
                console.log('üì• Response status:', response.status, response.statusText);
                
                if (response.ok) {
                    console.log('‚úÖ Session valid, showing quiz');
                    await showQuiz();
                } else {
                    console.log('‚ùå Session invalid, status:', response.status);
                    const errorText = await response.text();
                    console.log('‚ùå Error response:', errorText);
                    clearSession();
                    showLogin();
                }
            } catch (error) {
                console.error('‚ùå Session validation error:', error);
                console.error('‚ùå Error details:', error.message);
                clearSession();
                showLogin();
            }
        }
        
        function clearSession() {
            // 1. Clear all app storage completely
            sessionStorage.clear();
            localStorage.clear();

            // 2. Clear Google Identity Services cookies
            const googleCookies = ['NID', 'g_state', 'sessionId'];
            googleCookies.forEach(cookieName => {
                // Clear for current domain
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
                // Clear for parent domain
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; domain=.sevenphase.net`;
                // Clear for root domain
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; domain=sevenphase.net`;
            });

            // 3. Disable Google Identity Services
            try {
                if (typeof google !== 'undefined' && google.accounts?.id) {
                    google.accounts.id.disableAutoSelect();
                    google.accounts.id.cancel();
                }
            } catch (e) {
                console.log('Google Identity Services cleanup attempted');
            }

            console.log('‚úÖ Comprehensive session cleanup completed');
        }

        // CSV Parsing and Question Loading
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, ''));
            const questions = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.replace(/"/g, ''));
                const question = {};

                headers.forEach((header, index) => {
                    question[header.toLowerCase().replace(/\s+/g, '_')] = values[index];
                });

                questions.push(question);
            }

            return questions;
        }

        async function loadQuestionsFromBFF() {
            try {
                // Session is handled by HttpOnly cookies automatically
                const response = await fetch(`${BFF_BASE_URL}/questions`, {
                    credentials: 'include' // Include HttpOnly cookies
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        // Session expired, clear and redirect to login
                        clearSession();
                        showLogin();
                        throw new Error('Session expired. Please sign in again.');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const jsonData = await response.json();
                console.log('‚úÖ Questions loaded securely from BFF as JSON');
                return jsonData.questions;
            } catch (error) {
                console.error('‚ùå Error loading questions:', error);
                return null;
            }
        }

        // BFF Authentication: Handle Google OAuth response and create secure session
        async function handleCredentialResponse(response) {
            try {
                console.log('Google OAuth response received');
                
                // Validate response before processing
                if (!response || !response.credential) {
                    throw new Error('Invalid authentication response');
                }

                console.log('üîÑ Sending token to BFF for validation...');

                // Send token to BFF for server-side validation and session creation
                console.log('üì° Sending login request to BFF:', BFF_BASE_URL);
                const loginResponse = await fetch(`${BFF_BASE_URL}/login`, {
                    method: 'POST',
                    credentials: 'include', // Include cookies
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: response.credential
                    })
                });

                console.log('üì• Login response status:', loginResponse.status, loginResponse.statusText);

                if (!loginResponse.ok) {
                    const errorText = await loginResponse.text();
                    console.error('‚ùå Login failed with status:', loginResponse.status);
                    console.error('‚ùå Error response:', errorText);
                    
                    let errorMessage = 'Login failed';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${loginResponse.status}: ${errorText}`;
                    }
                    
                    throw new Error(errorMessage);
                }

                const loginData = await loginResponse.json();
                
                if (!loginData.success) {
                    throw new Error('Server authentication failed');
                }

                console.log('‚úÖ BFF Authentication successful for:', loginData.user.name);

                // Session stored securely in HttpOnly cookie - no client-side storage needed
                // Store only minimal user info for display purposes
                sessionStorage.setItem('user_info', JSON.stringify(loginData.user));

                // Hide login section and show quiz
                hideLogin();
                await showQuiz();

                // Create or open user answer spreadsheet
                try {
                    console.log('üìä Setting up user answer tracking...');
                    const userInfo = loginData.user;
                    const questionsCount = window.currentQuiz ? window.currentQuiz.questions.length : 35;

                    const spreadsheetInfo = await createOrOpenUserAnswerSheet(userInfo, questionsCount);

                    console.log('‚úÖ Answer tracking ready:', spreadsheetInfo.title);

                    // Show notification to user
                    if (spreadsheetInfo.isNew) {
                        showNotification(`üìä Created answer tracking spreadsheet: ${spreadsheetInfo.title}`, 'success');
                    } else {
                        showNotification(`üìä Using existing answer spreadsheet`, 'info');
                    }
                } catch (error) {
                    console.error('‚ö†Ô∏è Answer tracking setup failed:', error);
                    showNotification('‚ö†Ô∏è Answer tracking unavailable - answers will not be saved to your Drive', 'warning');
                }
            } catch (error) {
                console.error('‚ùå Authentication error:', error);
                alert(`Sign-in failed: ${error.message}`);
            }
        }

        // #claude Security: JWT decoding with validation
        function decodeJwtResponse(token) {
            try {
                // #claude Security: Validate JWT structure
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format');
                }
                
                const base64Url = parts[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                const payload = JSON.parse(jsonPayload);
                
                // #claude Security: Validate token expiration
                const now = Math.floor(Date.now() / 1000);
                if (payload.exp && payload.exp < now) {
                    throw new Error('Token has expired');
                }
                
                // #claude Security: Validate issuer
                if (payload.iss !== 'https://accounts.google.com') {
                    throw new Error('Invalid token issuer');
                }
                
                return payload;
            } catch (error) {
                console.error('JWT decode error:', error);
                throw new Error('Failed to decode authentication token');
            }
        }

        function hideLogin() {
            document.getElementById('loginSection').style.display = 'none';
        }

        async function showQuiz() {
            document.getElementById('quizContainer').style.display = 'block';

            // Display user info from session (not localStorage)
            const userInfo = JSON.parse(sessionStorage.getItem('user_info') || '{}');
            const header = document.querySelector('.header');
            
            // Check if user display already exists to prevent duplicates
            const existingUserDisplay = header.querySelector('.user-info');
            if (!existingUserDisplay) {
                // Add user info display only if it doesn't exist
                const userDisplay = document.createElement('div');
                userDisplay.className = 'user-info';
                // #claude Security: Sanitize user data to prevent XSS
                const safeName = (userInfo.name || 'User').replace(/[<>]/g, '');
                const safePicture = (userInfo.picture || '').replace(/[<>"']/g, '');
                
                userDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <img src="${safePicture}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%;" onerror="this.style.display='none'" loading="lazy">
                        <span style="color: #4a5568; font-weight: bold;">Welcome, ${safeName}!</span>
                        <button onclick="logout()" class="nav-button" style="margin-left: auto; padding: 8px 16px; font-size: 0.9em;">Logout</button>
                    </div>
                `;
                header.insertBefore(userDisplay, header.firstChild);
            }

            // If no quiz is initialized yet, load questions from BFF and initialize it
            if (!window.currentQuiz) {
                await initializeQuizFromBFF();
            }
        }

        // Initialize quiz by loading questions from BFF
        async function initializeQuizFromBFF() {
            try {
                console.log('üîÑ Loading questions from BFF for session validation...');
                const questions = await loadQuestionsFromBFF();
                console.log('üìä Questions from BFF:', questions ? questions.length : 'null/undefined', questions);
                if (questions && questions.length > 0) {
                    console.log('‚úÖ Starting quiz with', questions.length, 'questions');
                    window.currentQuiz = new MathQuiz(questions);
                } else {
                    console.error('‚ùå No questions received from BFF');
                    alert('Error loading questions. Please try again.');
                }
            } catch (error) {
                console.error('‚ùå Error initializing quiz:', error);
                alert('Error loading quiz. Please try again.');
            }
        }

        // BFF Logout: Secure logout with server-side session destruction
        async function logout() {
            try {
                // Notify BFF to clear HttpOnly session cookie
                try {
                    await fetch(`${BFF_BASE_URL}/logout`, {
                        credentials: 'include' // Include HttpOnly cookies
                    });
                    console.log('‚úÖ HttpOnly session cookie cleared');
                } catch (error) {
                    console.error('‚ö†Ô∏è Failed to clear server session:', error);
                    // Continue with client cleanup even if server logout fails
                }
                
                // Revoke Google token
                if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                    google.accounts.id.disableAutoSelect();
                }
                
                // Clear all client-side data
                clearSession();

                // Show login section again
                document.getElementById('loginSection').style.display = 'flex';
                document.getElementById('quizContainer').style.display = 'none';

                // Force page reload to clear any remaining state
                location.reload();
            } catch (error) {
                console.error('Logout error:', error);
                // Fallback: use comprehensive cleanup and reload
                clearSession();
                location.reload();
            }
        }



        // Show login section
        function showLogin() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('quizContainer').style.display = 'none';
        }

        // Check authentication state when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîÑ Page loaded, checking authentication state...');
            console.log('üìç Login section element:', document.getElementById('loginSection'));
            console.log('üìç Quiz container element:', document.getElementById('quizContainer'));
            initializeAuth();
        });
    </script>
</body>
</html>
