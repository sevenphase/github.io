<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 6 Math Quiz</title>
    <script src="https://accounts.google.com/gsi/client" async defer onload="initializeGsi"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .quiz-container {
            background: white;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 600px;
            width: 90%;
            position: relative;
            overflow: hidden;
        }

        .quiz-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f, #4d96ff, #9c88ff);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5em;
            color: #4a5568;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar {
            background: #e2e8f0;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #ff6b6b, #4d96ff);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }

        .score-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }

        .star-container {
            display: flex;
            gap: 5px;
        }

        .star {
            font-size: 2em;
            transition: all 0.3s ease;
            filter: grayscale(100%);
        }

        .star.earned {
            filter: grayscale(0%);
            transform: scale(1.2);
            animation: sparkle 0.6s ease;
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1.2); }
            50% { transform: scale(1.4) rotate(10deg); }
        }

        .question-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .question-number {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.4em;
            line-height: 1.4;
        }

        .topic-badge {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .answer-section {
            margin: 30px 0;
        }

        .answer-input {
            width: 100%;
            padding: 15px;
            border: 3px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.2em;
            outline: none;
            transition: all 0.3s ease;
        }

        .answer-input:focus {
            border-color: #4d96ff;
            box-shadow: 0 0 0 3px rgba(77, 150, 255, 0.2);
        }

        .multiple-choice {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .choice-button {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .choice-button.selected {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            transform: scale(1.02);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }

        .nav-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.5s ease;
        }

        .feedback.correct {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #2d5016;
        }

        .feedback.incorrect {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #c53030;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4a5568;
            font-size: 1.2em;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4d96ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .question-counter {
            font-size: 1.1em;
            color: #666;
            font-weight: bold;
        }

        .login-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .login-container {
            background: white;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        .login-title {
            font-size: 2.5em;
            color: #4a5568;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .login-subtitle {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
        }

        .user-info {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }

        .user-info img {
            border: 2px solid #4d96ff;
        }

        .user-info button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-info button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="loginSection" class="login-section" style="display: none;">
        <div class="login-container">
            <h1 class="login-title">Math Quiz Adventure!</h1>
            <p class="login-subtitle">Sign in with Google to start your math adventure!</p>
            <div id="g_id_onload"
                 data-client_id="141726088289-7rvc4j711ac0ospiiuam4bdmuklahsbe.apps.googleusercontent.com"
                 data-context="signin"
                 data-ux_mode="popup"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin"
                 data-type="standard"
                 data-shape="rectangular"
                 data-theme="outline"
                 data-text="signin_with"
                 data-size="large"
                 data-logo_alignment="left">
            </div>
        </div>
    </div>

    <div class="quiz-container" id="quizContainer" style="display: none;">
        <div class="header">
            <h1 class="title">Math Quiz Adventure!</h1>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="score-display">
                <span style="font-size: 1.2em; font-weight: bold; color: #4a5568;">Score:</span>
                <div class="star-container" id="starContainer">
                    <span class="star">⭐</span>
                    <span class="star">⭐</span>
                    <span class="star">⭐</span>
                    <span class="star">⭐</span>
                    <span class="star">⭐</span>
                </div>
                <span id="scoreText" style="font-size: 1.2em; font-weight: bold; color: #4a5568;">0/5</span>
            </div>
        </div>

        <div id="loadingScreen" class="loading">
            <div class="spinner"></div>
            <div>Loading your math adventure...</div>
        </div>

        <div id="quizContent" style="display: none;">
            <div class="question-counter">
                <span id="questionCounter">Question 1 of 5</span>
            </div>

            <div class="question-card">
                <div class="question-number" id="questionNumber">Question 1</div>
                <div class="question-text" id="questionText">Loading question...</div>
                <div class="topic-badge" id="topicBadge">Topic</div>
            </div>

            <div class="answer-section">
                <input type="text" class="answer-input" id="textAnswer" placeholder="Type your answer here..." style="display: none;">
                <div class="multiple-choice" id="multipleChoice" style="display: none;"></div>
            </div>

            <div class="controls">
                <button class="nav-button" id="prevButton" disabled>
                    ← Previous
                </button>
                <button class="submit-button" id="submitButton">Submit Answer</button>
                <button class="nav-button" id="nextButton" disabled>
                    Next →
                </button>
            </div>

            <div id="feedback" class="feedback" style="display: none;"></div>
        </div>
    </div>

    <script>
        let googleUser = null;
        let isGoogleInitialized = false;

        class MathQuiz {
            constructor(questions = null) {
                this.questions = questions || [];
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.answers = {};
                this.selectedChoice = null;

                if (questions && questions.length > 0) {
                    this.initWithQuestions();
                } else {
                    this.init();
                }
            }

            initWithQuestions() {
                this.setupEventListeners();
                this.displayQuestion();
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('quizContent').style.display = 'block';
            }

            async init() {
                try {
                    await this.loadQuestions();
                    this.setupEventListeners();
                    this.displayQuestion();
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('quizContent').style.display = 'block';
                } catch (error) {
                    document.getElementById('loadingScreen').innerHTML = `
                        <div style="color: #e53e3e; text-align: center;">
                            <h2>Failed to Load Quiz</h2>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }

            async loadQuestions() {
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbybGyQtOKz4HEvMX8j8Tvb6Wkngx19RB5ulHidh_Ge6_JUd1eWGZ7GSl_xtukIv5mQ2/exec';

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const csvText = await response.text();
                if (!csvText || csvText.length === 0) {
                    throw new Error('Empty response from Apps Script');
                }

                this.questions = this.parseCSV(csvText);
                if (this.questions.length === 0) {
                    throw new Error('No questions found in spreadsheet');
                }
            }

            parseCSV(csvText) {
                const lines = csvText.split('\n').filter(line => line.trim());
                const questions = [];

                for (let i = 1; i < lines.length; i++) {
                    try {
                        const columns = this.parseCSVLine(lines[i]);
                        if (columns.length >= 5) {
                            const question = {
                                number: parseInt(columns[0]) || i,
                                question: columns[1]?.trim() || '',
                                topic: columns[2]?.trim() || '',
                                answerType: columns[3]?.trim() || 'Short Answer',
                                answer: columns[4]?.trim() || ''
                            };

                            if (question.answerType === 'Multiple Choice') {
                                const answerText = question.answer;
                                const choiceMatches = answerText.match(/[A-D]\)[^A-D\[\]]+/g);
                                if (choiceMatches) {
                                    question.choices = choiceMatches.map(choice => choice.trim());
                                }

                                const correctMatch = answerText.match(/\[Correct:\s*([A-D])\]/i);
                                question.answer = correctMatch ? correctMatch[1].toUpperCase() : 'A';
                            }

                            if (question.question) {
                                questions.push(question);
                            }
                        }
                    } catch (error) {
                        console.warn(`Error parsing line ${i}:`, error);
                    }
                }

                return questions;
            }

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current);
                return result;
            }

            setupEventListeners() {
                document.getElementById('submitButton').addEventListener('click', () => this.submitAnswer());
                document.getElementById('prevButton').addEventListener('click', () => this.previousQuestion());
                document.getElementById('nextButton').addEventListener('click', () => this.nextQuestion());
                document.getElementById('textAnswer').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.submitAnswer();
                });
            }

            displayQuestion() {
                const question = this.questions[this.currentQuestionIndex];
                document.getElementById('questionNumber').textContent = `Question ${question.number}`;
                document.getElementById('questionText').textContent = question.question;
                document.getElementById('topicBadge').textContent = question.topic;
                document.getElementById('questionCounter').textContent = `Question ${this.currentQuestionIndex + 1} of ${this.questions.length}`;

                this.updateProgress();
                this.setupAnswerInput(question);
                this.updateNavigationButtons();
                this.hideFeedback();
            }

            setupAnswerInput(question) {
                const textInput = document.getElementById('textAnswer');
                const multipleChoice = document.getElementById('multipleChoice');

                if (question.answerType === 'Multiple Choice') {
                    textInput.style.display = 'none';
                    multipleChoice.style.display = 'grid';
                    multipleChoice.innerHTML = '';

                    question.choices.forEach((choice, index) => {
                        const button = document.createElement('button');
                        button.className = 'choice-button';
                        button.textContent = choice;
                        button.addEventListener('click', () => this.selectChoice(index, button));
                        multipleChoice.appendChild(button);
                    });
                } else {
                    textInput.style.display = 'block';
                    multipleChoice.style.display = 'none';
                    textInput.value = this.answers[this.currentQuestionIndex] || '';
                    textInput.focus();
                }

                this.selectedChoice = null;
            }

            selectChoice(index, button) {
                document.querySelectorAll('.choice-button').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                this.selectedChoice = index;
            }

            submitAnswer() {
                const question = this.questions[this.currentQuestionIndex];
                let userAnswer;

                if (question.answerType === 'Multiple Choice') {
                    if (this.selectedChoice === null) {
                        alert('Please select an answer!');
                        return;
                    }
                    userAnswer = String.fromCharCode(65 + this.selectedChoice);
                } else {
                    userAnswer = document.getElementById('textAnswer').value.trim();
                    if (!userAnswer) {
                        alert('Please enter an answer!');
                        return;
                    }
                }

                this.answers[this.currentQuestionIndex] = userAnswer;
                const isCorrect = this.checkAnswer(userAnswer, question.answer);

                if (isCorrect && !this.isQuestionAnswered(this.currentQuestionIndex)) {
                    this.score++;
                    this.updateStars();
                }

                this.showFeedback(isCorrect, question.answer);
                this.updateNavigationButtons();
            }

            checkAnswer(userAnswer, correctAnswer) {
                const normalize = (answer) => answer.toString().toLowerCase().replace(/[,\s]/g, '');
                return normalize(userAnswer) === normalize(correctAnswer);
            }

            isQuestionAnswered(index) {
                return this.answers.hasOwnProperty(index);
            }

            showFeedback(isCorrect, correctAnswer) {
                const feedback = document.getElementById('feedback');
                feedback.style.display = 'block';

                if (isCorrect) {
                    feedback.className = 'feedback correct';
                    feedback.innerHTML = 'Excellent! You got it right!';
                } else {
                    feedback.className = 'feedback incorrect';
                    feedback.innerHTML = `Not quite right. The correct answer is: ${correctAnswer}`;
                }
            }

            hideFeedback() {
                document.getElementById('feedback').style.display = 'none';
            }

            updateStars() {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    if (index < this.score) {
                        star.classList.add('earned');
                    }
                });
                document.getElementById('scoreText').textContent = `${this.score}/${this.questions.length}`;
            }

            updateProgress() {
                const progress = ((this.currentQuestionIndex + 1) / this.questions.length) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
            }

            updateNavigationButtons() {
                const prevButton = document.getElementById('prevButton');
                const nextButton = document.getElementById('nextButton');
                const submitButton = document.getElementById('submitButton');

                prevButton.disabled = this.currentQuestionIndex === 0;
                nextButton.disabled = this.currentQuestionIndex === this.questions.length - 1;

                if (this.isQuestionAnswered(this.currentQuestionIndex)) {
                    submitButton.textContent = 'Update Answer';
                    nextButton.disabled = false;
                } else {
                    submitButton.textContent = 'Submit Answer';
                }
            }

            previousQuestion() {
                if (this.currentQuestionIndex > 0) {
                    this.currentQuestionIndex--;
                    this.displayQuestion();
                }
            }

            nextQuestion() {
                if (this.currentQuestionIndex < this.questions.length - 1) {
                    this.currentQuestionIndex++;
                    this.displayQuestion();
                }
            }
        }

        // Google OAuth Functions
        function initializeGsi() {
            console.log('Initializing Google Identity Services...');
            
            google.accounts.id.initialize({
                client_id: "141726088289-7rvc4j711ac0ospiiuam4bdmuklahsbe.apps.googleusercontent.com",
                callback: handleCredentialResponse,
                auto_select: false
            });

            isGoogleInitialized = true;
            checkAuthenticationState();
        }

        function checkAuthenticationState() {
            // Check if user info exists in localStorage (as fallback)
            const storedUserInfo = localStorage.getItem('user_info');
            
            if (storedUserInfo) {
                try {
                    googleUser = JSON.parse(storedUserInfo);
                    if (googleUser.name && googleUser.email) {
                        console.log('Found stored user info, showing quiz');
                        showQuiz();
                        loadAndStartQuiz();
                        return;
                    }
                } catch (error) {
                    console.error('Invalid stored user info, clearing...');
                    localStorage.removeItem('user_info');
                    localStorage.removeItem('google_token');
                }
            }

            // Use Google's prompt to check for existing session
            google.accounts.id.prompt((notification) => {
                if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                    // User might be already signed in or dismissed
                    console.log('Google prompt not displayed, showing login');
                    showLogin();
                } else {
                    // Show login screen
                    showLogin();
                }
            });
        }

        async function handleCredentialResponse(response) {
            console.log('Google OAuth response received');

            try {
                const userInfo = parseJwtToken(response.credential);
                
                if (userInfo) {
                    googleUser = userInfo;
                    
                    // Store for session persistence (temporary fallback)
                    localStorage.setItem('google_token', response.credential);
                    localStorage.setItem('user_info', JSON.stringify(userInfo));
                    
                    console.log('User authenticated:', userInfo.name);
                    hideLogin();
                    showQuiz();
                    
                    const questions = await loadQuestionsFromSpreadsheet();
                    if (questions && questions.length > 0) {
                        new MathQuiz(questions);
                    } else {
                        alert('Error loading questions. Please try again.');
                    }
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showLogin();
            }
        }

        function parseJwtToken(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                const payload = JSON.parse(jsonPayload);
                
                // Basic validation
                if (payload.aud !== '141726088289-7rvc4j711ac0ospiiuam4bdmuklahsbe.apps.googleusercontent.com') {
                    throw new Error('Invalid audience');
                }
                
                if (payload.exp < Date.now() / 1000) {
                    throw new Error('Token expired');
                }
                
                return {
                    name: payload.name,
                    email: payload.email,
                    picture: payload.picture,
                    sub: payload.sub
                };
            } catch (error) {
                console.error('Token parsing failed:', error);
                return null;
            }
        }

        async function loadQuestionsFromSpreadsheet() {
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbybGyQtOKz4HEvMX8j8Tvb6Wkngx19RB5ulHidh_Ge6_JUd1eWGZ7GSl_xtukIv5mQ2/exec');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const csvText = await response.text();
                return parseSimpleCSV(csvText);
            } catch (error) {
                console.error('Error loading questions:', error);
                return [];
            }
        }

        function parseSimpleCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const questions = [];

            for (let i = 1; i < lines.length; i++) {
                try {
                    const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                    if (values.length >= 5 && values[1]) {
                        questions.push({
                            number: parseInt(values[0]) || i,
                            question: values[1],
                            topic: values[2] || 'Math',
                            answerType: values[3] || 'Short Answer',
                            answer: values[4]
                        });
                    }
                } catch (error) {
                    console.warn(`Error parsing line ${i}:`, error);
                }
            }

            return questions;
        }

        function showLogin() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('quizContainer').style.display = 'none';
            
            if (isGoogleInitialized) {
                google.accounts.id.renderButton(
                    document.querySelector('.g_id_signin'),
                    { 
                        theme: 'outline', 
                        size: 'large',
                        text: 'signin_with',
                        shape: 'rectangular'
                    }
                );
            }
        }

        function hideLogin() {
            document.getElementById('loginSection').style.display = 'none';
        }

        function showQuiz() {
            document.getElementById('quizContainer').style.display = 'block';

            if (googleUser) {
                const header = document.querySelector('.header');
                
                // Remove existing user display
                const existingUserDisplay = header.querySelector('.user-info');
                if (existingUserDisplay) {
                    existingUserDisplay.remove();
                }

                // Add user info display
                const userDisplay = document.createElement('div');
                userDisplay.className = 'user-info';
                userDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <img src="${googleUser.picture || ''}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%;" onerror="this.style.display='none'">
                        <span style="color: #4a5568; font-weight: bold;">Welcome, ${googleUser.name || 'User'}!</span>
                        <button onclick="logout()" style="margin-left: auto; padding: 8px 16px; font-size: 0.9em;">Logout</button>
                    </div>
                `;
                header.insertBefore(userDisplay, header.firstChild);
            }
        }

        async function loadAndStartQuiz() {
            try {
                const questions = await loadQuestionsFromSpreadsheet();
                if (questions && questions.length > 0) {
                    new MathQuiz(questions);
                } else {
                    document.getElementById('loadingScreen').innerHTML = `
                        <div style="color: #e53e3e; text-align: center;">
                            <h2>No Questions Found</h2>
                            <p>Please check your Google Sheets configuration.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading quiz:', error);
                document.getElementById('loadingScreen').innerHTML = `
                    <div style="color: #e53e3e; text-align: center;">
                        <h2>Error Loading Quiz</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function logout() {
            console.log('Logging out user...');
            
            try {
                google.accounts.id.disableAutoSelect();
                googleUser = null;
                localStorage.removeItem('google_token');
                localStorage.removeItem('user_info');
                showLogin();
                console.log('User logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
                googleUser = null;
                localStorage.removeItem('google_token');
                localStorage.removeItem('user_info');
                showLogin();
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, waiting for Google Identity Services...');
            
            if (typeof google === 'undefined' || !google.accounts) {
                console.log('Waiting for Google Identity Services to load...');
                // The onload="initializeGsi" in the script tag will handle initialization
            } else {
                initializeGsi();
            }
        });
    </script>
</body>
</html>
